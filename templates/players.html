<head>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
            integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
            crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">
    <link rel="apple-touch-icon" sizes="180x180"
          href="{{ url_for('static',filename='img/favicons/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32"
          href="{{ url_for('static',filename='img/favicons/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16"
          href="{{ url_for('static',filename='img/favicons/favicon-16x16.png') }}">
    <link rel="manifest" href="{{ url_for('static',filename='img/favicons/site.webmanifest') }}">
    <link rel="mask-icon" href="{{ url_for('static',filename='img/favicons//safari-pinned-tab.svg') }}" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <title>r/nba flair tool</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/style.css') }}">
</head>
<body>
<div class="hdr-container">
    <div class="columns col-oneline">
        <div class="column col-7 col-mx-auto">
			<header class="navbar">
				<section class="navbar-section">
					<a href="//www.reddit.com/r/nba" class="navbar-brand mr-2">r/nba</a>
					<a href="//www.twitter.com/nba_reddit" class="btn btn-link">Twitter</a>
					<a href="//discord.gg/nba" class="btn btn-link">Discord</a>
				</section>
			</header>
		</div>
	</div>
</div>
<div class="container">
    <div class="columns col-oneline">
        <div class="column col-7 col-mx-auto">
            <section id="preview">
                <div class="card">
                    {% if not session.username %}
                        <div class="card-header">
                            <div class="card-title h5">Reddit Authentication</div>
							<div class="card-subtitle text-gray">Please authenticate on reddit before continuing</div>
                        </div>
                        <div class="card-body">
                        <header class="navbar">
                            <section class="navbar-section">
                                <a class="authenticate btn" href="{{ authorize_url }}">
                                    Authenticate</a>
                            </section>
                            <section class="navbar-center"></section>
                        </header>
                    {% else %}
                        <div class="card-header">
                            <div class="card-title h5">Flair Preview</div>
                        </div>
                        <div class="card-body">
                        <header class="navbar">
                            <section class="navbar-section">
                                <button class="btn" id="logout" href="#">Logout</button>
                            </section>
                            <section class="navbar-center">
                                <a href="//www.reddit.com/u/{{ session.username }}"
                                   id="username">{{ session.username }}</a>
                                <span class="flair flair-{{ session.userflair_class }}">{{ session.userflair_text }}</span>
                            </section>
                            <section class="navbar-section">
								<button class="btn btn-primary hidden" id="submit">Submit</button>
                            </section>
                        </header>
                    {% endif %}
                    </div>
                    </div>
            </section>
        </div>
    </div>
	{% if not session.username %}
	{% else %}
    <div class="columns col-oneline">
        <div class="column col-7 col-mx-auto">
            <div class="card" id="teams">
                <div class="card-header">
                    <div class="card-title h5">Player Flair Tool</div>
                    <div class="card-subtitle text-gray">Select your team</div>
                </div>
                <div class="card-body">
                    <ul class="text-center selectable">
                        <li><a class="flair flair-Mavs2"></a></li>
                        <li><a class="flair flair-Nuggets1"></a></li>
                        <li><a class="flair flair-Warriors1"></a></li>
                        <li><a class="flair flair-Rockets1"></a></li>
                        <li><a class="flair flair-Clippers1"></a></li>
                        <li><a class="flair flair-Lakers2"></a></li>
                        <li><a class="flair flair-Grizzlies1"></a></li>
                        <li><a class="flair flair-Timberwolves1"></a></li>
                        <li><a class="flair flair-Pelicans3"></a></li>
                        <li><a class="flair flair-Thunder1"></a></li>
                        <li><a class="flair flair-Suns4"></a></li>
                        <li><a class="flair flair-TrailBlazers1"></a></li>
                        <li><a class="flair flair-Kings1"></a></li>
                        <li><a class="flair flair-Spurs3"></a></li>
                        <li><a class="flair flair-Jazz1"></a></li>
                        <li><a class="flair flair-SuperSonics1"></a></li>
                        <li><a class="flair flair-Hawks1"></a></li>
                        <li><a class="flair flair-Celtics1"></a></li>
                        <li><a class="flair flair-Nets1"></a></li>
                        <li><a class="flair flair-ChaHornets1"></a></li>
                        <li><a class="flair flair-Bulls1"></a></li>
                        <li><a class="flair flair-Cavaliers3"></a></li>
                        <li><a class="flair flair-Pistons1"></a></li>
                        <li><a class="flair flair-Pacers2"></a></li>
                        <li><a class="flair flair-Heat1"></a></li>
                        <li><a class="flair flair-Bucks2"></a></li>
                        <li><a class="flair flair-Knicks1"></a></li>
                        <li><a class="flair flair-Magic1"></a></li>
                        <li><a class="flair flair-76ers1"></a></li>
                        <li><a class="flair flair-Raptors1"></a></li>
                        <li><a class="flair flair-Wizards2"></a></li>
                        <li><a class="flair flair-NBA"></a></li>
                    </ul>
                </div>
            </div>

            <section id="logos" class="hidden">
                <div class="divider text-center" data-content="SELECT A LOGO"></div>
                <div class="selector text-center"></div>
            </section>
        </div>

        <div id="player-divider" class="divider-vert hidden" data-content=">"></div>

        <div id="player-search" class="column col-3 col-mx-auto hidden">
            <section>
                <div class="input-group input-inline centered has-icon-left">
                    <input class="form-input" placeholder="Search player" id="searchInput">
                    <i class="form-icon icon icon-search"></i>
                </div>
            </section>

            <section id="player-options">
                <div class="form-group ui-widget" id="players"></div>
            </section>
        </div>
    </div>
	{% endif %}
</div>
</body>

<script>
    // Logout button code
    $('#logout').click(() => {
        window.location.href = '/logout';
    })

    $(document).on("mouseenter", ".selectable:not(.initiated)", function () {
        // Team selection: slide logos down, disable player search, etc.
        $('#teams .flair').one("click", function () {
            $('#logos').slideDown(400).removeClass('hidden');
            $('.form-input').attr("disabled", true);
			$('#submit').addClass('hidden');
            $('#player-divider').attr("data-content", "<");
			$('span.flair').text('');
        });
		// Team selection: add logos html
        $('#teams .flair').on('click', (e => {
                flairclass = e.target.classList[1];
                html = "<ul class=\"selectable\">";
                if (flairclass != "flair-NBA") {
                    for (i in [...Array(5).keys()]) {
                        html += "<li><a class='flair " + flairclass.slice(0, -1) + (parseInt(i) + 1) + "'></a></li>";
                    }
                }
                else {
                    html += "<li><a class='flair flair-NBA'></a></li>";
                }
                html += "</ul>";
                $(".selector").html(html);
                $('#searchInput').val('');
                $('#players').html('');
            })
        );
		// Flair selection: change preview flair image
        $('.flair').on('click', (e => {
            $('span.flair').attr("class", $('.ui-selected a').attr('class'));
        }));
        // Logo selection: unhide player search + Player search code
        $('#logos .flair').on('click', (e => {
            $('#player-divider').removeClass('hidden');
            $('#player-search').removeClass('hidden');
            $('.form-input').attr('disabled', false);
            $('#player-divider').attr("data-content", ">");
            $('span.flair').attr("class", $('#logos .ui-selected a').attr('class'));
            $.getJSON('/autocomplete', {
                search_input: $('#searchInput').val(),
                team_input: $('.ui-selected a').attr('class').split(' ')[1]
            }, function (data) {
                $("#searchInput").autocomplete({
                    search: function (event, ui) {
                        $('#players').empty();
                    },
                    source: data
                }).data('ui-autocomplete')._renderItem = function (ul, item) {
                    return $("<li></li>").data("item.autocomplete", item)
                        .append("<label class=\"form-radio\">\n<input type=\"radio\" name=\"player\" value=\"" + item.value + "\">\n<i class=\"form-icon\"></i> " + item.value + "\n</input></label>")
                        .appendTo($('#players'));
                };
            });
        }));
        // Flair selection: add class to distinguish selection
        $(this).selectable({
            filter: " li ",
            selected: function (event, ui) {
                $(ui.selected).addClass("ui-selected").siblings().removeClass("ui-selected").addClass("ui-unselected");
            }
        });
    });
	// Select player: change preview, show submit button
    $('#player-options').on('click', 'input:radio',((e)=>{
        $('span.flair').text(e.target.value);
		$('#submit').removeClass('hidden');
    }))
	// Submit button code
    $('#submit').click(() => {
        let flairclass = $('#logos .ui-selected a').attr('class').split(' ')[1];
        let team_code = team_map[flairclass.slice(0, -1)][0];
        let player_name = $('input:checked').val();

        $.getJSON('/submit', {
            player_name: player_name,
            team_code: team_code,
            css_class: flairclass,
            user_name: $('#username').text()
        }, (data) => {
            if ('error' in data) {
                toastr.error(data.error);
            }
            else if ('success' in data) {
                toastr.success(data.success);
            }
        });
    });

    let team_map = {
        'flair-Hawks': ['ATL', 'MLH', 'STL', 'TRI'],
        'flair-Celtics': ['BOS'],
        'flair-Nets': ['BRK', 'NYA', 'NYN', 'NJN', 'NJA'],
        'flair-ChaHornets': ['CHO', 'CHA', 'CHH'],
        'flair-Bulls': ['CHI'],
        'flair-Cavaliers': ['CLE'],
        'flair-Mavs': ['DAL'],
        'flair-Nuggets': ['DEN', 'DNA', 'DNR'],
        'flair-Pistons': ['DET', 'FTW'],
        'flair-Warriors': ['GSW', 'SFW', 'PHW'],
        'flair-Rockets': ['HOU', 'SDR'],
        'flair-Pacers': ['IND', 'INA'],
        'flair-Clippers': ['LAC', 'SDC', 'BUF'],
        'flair-Lakers': ['LAL', 'MNL'],
        'flair-Grizzlies': ['MEM', 'VAN'],
        'flair-Heat': ['MIA'],
        'flair-Bucks': ['MIL'],
        'flair-Timberwolves': ['MIN'],
        'flair-Pelicans': ['NOP', 'NOK', 'NOH'],
        'flair-Knicks': ['NYK'],
        'flair-Thunder': ['OKC', 'SEA'],
        'flair-Magic': ['ORL'],
        'flair-76ers': ['PHI', 'SYR'],
        'flair-Suns': ['PHO'],
        'flair-TrailBlazers': ['POR'],
        'flair-Kings': ['SAC', 'CIN', 'KCO', 'KCK', 'ROC'],
        'flair-Spurs': ['SAS', 'TEX', 'SAA', 'DLC'],
        'flair-Raptors': ['TOR'],
        'flair-Jazz': ['UTA', 'NOJ'],
        'flair-Wizards': ['WAS', 'CHZ', 'BAL', 'CAP', 'WSB', 'CHP'],
        'flair-SuperSonics': ['SEA'],
    }
</script>
